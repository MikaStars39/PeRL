<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluation Monitor</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    .ui.container {
      width: 98% !important;
      max-width: 1200px !important;
    }
    table {
      text-align: center !important;
    }
  </style>
</head>

<body>
  <div id="app" class="ui container">
    <div class="ui segment" style="margin-top: -5px">
      <div class="ui stackable grid">
        <div class="twelve wide column">
          <div class="ui tiny label">Evaluation Monitor</div>
          <div class="meta" style="margin-top: 0.5rem">
            <span v-if="loading">数据更新中...</span>
            <span v-else>实时轮询最新评估状态（默认间隔: 10s 每次；最近更新：[[ lastUpdate ]]）</span>
          </div>
        </div>
        <div class="four wide column right aligned">
          <button class="ui teal right labeled icon button" :class="{loading: loading}" @click="fetchData">
            <i class="refresh icon"></i>
            手动刷新
          </button>
        </div>
      </div>
    </div>

    <div v-if="error" class="ui negative message">
      <div class="header">加载失败</div>
      <p>[[ error ]]</p>
    </div>
    <div v-else-if="experiments.length === 0 && !loading" class="ui info message">
      <div class="header">暂无评估结果</div>
      <p>等待新的实验任务完成后会自动显示。</p>
    </div>

    <div v-for="exp in sortedExperiments" :key="exp.exp_name" class="ui fluid card">
      <div class="content">
        <!-- <div class="ui stackable grid">
          <div class="sixteen wide column">
            <div class="ui fluid progress" style="margin-bottom: 0" :class="exp.status === 'finished' ? 'success' : 'active'">
              <div class="bar" :style="{ width: (exp.process * 100).toFixed(1) + '%' }">
                <div class="progress">[[ (exp.process * 100).toFixed(1) ]]%</div>
              </div>
            </div>
          </div>
        </div> -->
        <div class="ui stackable grid">
          <div class="sixteen wide column">
            <div class="ui header">
              <!-- <div :class="['ui', 'label', exp.status === 'finished' ? 'green' : 'orange']">
                [[ exp.status ]] · [[ (exp.process * 100).toFixed(1) ]]%
              </div> -->
              [[ exp.exp_name ]]
            </div>
            <div class="ui meta small relaxed list">
              <div class="item"><i class="clock outline icon"></i>
                <div class="content">Last Update: [[ formatDate(exp.last_update) ]]</div>
              </div>
              <div class="item"><i class="database icon"></i>
                <div class="content">Size: [[ exp.size ]]</div>
              </div>
              <div class="item"><i class="folder open icon"></i>
                <div class="content">Dir: [[ exp.result_dir ]]</div>
              </div>
            </div>
          </div>
        </div>
        <br>

        <div class="ui five small stackable statistics">
          <div class="statistic">
            <div class="value">[[ (exp.avg * 100).toFixed(1) ]]</div>
            <div class="label">Avg</div>
          </div>
          <div class="statistic">
            <div class="value">[[ (exp.max * 100).toFixed(1) ]]</div>
            <div class="label">Max</div>
          </div>
          <div class="statistic">
            <div class="value">[[ (exp.min * 100).toFixed(1) ]]</div>
            <div class="label">Min</div>
          </div>
          <div class="statistic">
            <div class="value">[[ (exp.std * 100).toFixed(1) ]]</div>
            <div class="label">Std</div>
          </div>
          <div class="statistic">
            <div class="value">[[ (exp.truncated * 100).toFixed(2) ]]%</div>
            <div class="label">Truncated</div>
          </div>
        </div>
      </div>

      <div class="content">
        <table class="ui celled very compact table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Task</th>
              <th>Size</th>
              <th>Avg</th>
              <th>Max</th>
              <th>Min</th>
              <th>Std</th>
              <th>Truncated</th>
              <th>Last Update</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="task in exp.results" :key="task.task_name">
              <td>
                <div :class="['ui', 'label', task.status === 'finished' ? 'green' : 'orange']">
                  [[ task.status ]] · [[ (task.process * 100).toFixed(0) ]]%
                </div>
              </td>
              <td>[[ task.task_name ]]</td>
              <td>[[ task.size ]]</td>
              <td>[[ (task.avg * 100).toFixed(1) ]]</td>
              <td>[[ (task.max * 100).toFixed(1) ]]</td>
              <td>[[ (task.min * 100).toFixed(1) ]]</td>
              <td>[[ (task.std * 100).toFixed(1) ]]</td>
              <td>[[ (task.truncated * 100).toFixed(2) ]]%</td>
              <td>[[ formatDate(task.last_update) ]]</td>
              <td>
                <div class="ui mini buttons">
                  <template v-if="task.status === 'running'">
                    <a class="ui teal button" :href="'/download/' + task.relative_path + '/output.jsonl'">Output</a>
                    <a class="ui orange button" :href="'/download/' + task.relative_path + '/process.txt'">Process</a>
                  </template>
                  <template v-else-if="task.status === 'finished'">
                    <a class="ui teal button" :href="'/download/' + task.relative_path + '/output.jsonl'">Output</a>
                    <a class="ui green button" :href="'/download/' + task.relative_path + '/result.jsonl'">Results</a>
                  </template>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 任务注释: 依照需求用 Semantic UI Vue 风格重构界面，尽量使用原生样式且不新增自定义 CSS，同时保留 Vue 轮询/排序/下载逻辑；实现: 引入 Semantic UI 资源并复用 fetch 逻辑与 10s 轮询
    const { createApp } = Vue;

    createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          experiments: [],
          loading: false,
          error: null,
          lastUpdate: '-',
          timer: null
        };
      },
      computed: {
        sortedExperiments() {
          return [...this.experiments].sort((a, b) => {
            const dateA = new Date(a.last_update);
            const dateB = new Date(b.last_update);
            return dateB - dateA;
          });
        }
      },
      methods: {
        formatDate(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          if (isNaN(date.getTime()) || date.getTime() === 0) return '-';
          return date.toLocaleString();
        },
        async fetchData() {
          this.loading = true;
          try {
            const response = await fetch('/api/results');
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.json();
            this.experiments = data;
            this.lastUpdate = new Date().toLocaleTimeString();
            this.error = null;
          } catch (err) {
            this.error = 'Failed to fetch data: ' + err.message;
            console.error('Fetch error:', err);
          } finally {
            this.loading = false;
          }
        }
      },
      mounted() {
        this.fetchData();
        // 需求: 自动轮询改为每10秒一次，除非手动点击刷新；实现: setInterval 间隔改为 10000ms，并保留手动触发 fetchData
        this.timer = setInterval(this.fetchData, 10000);
      },
      beforeUnmount() {
        if (this.timer) clearInterval(this.timer);
      }
    }).mount('#app');
  </script>
</body>

</html>